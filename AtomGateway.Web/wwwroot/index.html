<!DOCTYPE html>
<html>
<head>
    <title>Atom Gateway Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 15px; height: 400px; overflow-y: scroll; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #eee; }
        .identity-card { border: 2px solid #007bff; padding: 20px; margin: 20px 0; border-radius: 8px; background: #f8f9ff; }
        .identity-card h3 { margin-top: 0; color: #007bff; }
        .identity-card img { max-width: 200px; border: 2px solid #ddd; border-radius: 4px; margin: 10px 0; }
        .input-group { display: flex; gap: 10px; margin: 20px 0; }
        input { padding: 12px; flex: 1; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-box { flex: 1; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center; }
        .stat-box h4 { margin: 0 0 5px 0; color: #6c757d; font-size: 12px; }
        .stat-box .value { font-size: 24px; font-weight: bold; color: #007bff; }
        .alert { padding: 12px; margin: 10px 0; border-radius: 5px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Atom Gateway Dashboard</h1>
        
        <div id="status" class="status disconnected">
             Desconectado do servidor
        </div>

        <div id="alert" class="alert"></div>

        <div class="stats">
            <div class="stat-box">
                <h4>MENSAGENS RECEBIDAS</h4>
                <div class="value" id="msgCount">0</div>
            </div>
            <div class="stat-box">
                <h4>MENSAGENS ENVIADAS</h4>
                <div class="value" id="sentCount">0</div>
            </div>
            <div class="stat-box">
                <h4>IDENTIDADES</h4>
                <div class="value" id="idCount">0</div>
            </div>
            <div class="stat-box">
                <h4>CONEX√ÉO SERIAL</h4>
                <div class="value" id="serialStatus"></div>
            </div>
        </div>

        <h2>Enviar para Atom</h2>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Digite mensagem para o Atom..." disabled>
            <button id="sendBtn" onclick="sendToAtom()" disabled>Enviar</button>
        </div>

        <h2>Log de Eventos</h2>
        <div id="log" class="log"></div>

        <h2>Identidades Recebidas (DTC)</h2>
        <div id="identities"></div>
    </div>

    <script>
        let messageCount = 0;
        let sentCount = 0;
        let identityCount = 0;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5000/atomhub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // Quando receber dados DO Atom
        connection.on("DataReceived", (message) => {
            messageCount++;
            updateStats();
            addLog(`<strong>ATOM ‚Üí SERVIDOR:</strong> ${message.type} - ${message.rawData}`, '#d4edda');
        });

        // Quando uma mensagem for enviada com sucesso PARA o Atom
        connection.on("MessageSent", (data) => {
            sentCount++;
            updateStats();
            addLog(`<strong>SERVIDOR ‚Üí ATOM:</strong> ${data.message}`, '#cfe2ff');
            showAlert('Mensagem enviada para o Atom!', 'success');
        });

        connection.on("IdentityReceived", (dtcData) => {
            identityCount++;
            updateStats();
            addLog(`<strong>IDENTIDADE COMPLETA:</strong> ${dtcData.passengerName || 'N/A'}`, '#d1ecf1');
            displayIdentity(dtcData);
        });

        connection.on("SerialStatus", (isConnected) => {
            document.getElementById('serialStatus').textContent = isConnected ? 'V' : 'X';
            addLog(`üîå <strong>Status Serial:</strong> ${isConnected ? 'CONECTADO' : 'DESCONECTADO'}`, isConnected ? '#d4edda' : '#f8d7da');
        });

        connection.on("Error", (errorMessage) => {
            addLog(`<strong>ERRO:</strong> ${errorMessage}`, '#f8d7da');
            showAlert('X' + errorMessage, 'error');
        });

        connection.onreconnecting(() => {
            updateStatus(false);
            addLog('<strong>Reconectando...</strong>', '#fff3cd');
        });

        connection.onreconnected(() => {
            updateStatus(true);
            addLog('<strong>Reconectado!</strong>', '#d4edda');
        });

        connection.onclose(() => {
            updateStatus(false);
            addLog('<strong>Conex√£o perdida</strong>', '#f8d7da');
        });

        connection.start()
            .then(() => {
                addLog("<strong>Conectado ao servidor SignalR</strong>", '#d4edda');
                updateStatus(true);
            })
            .catch(err => {
                addLog(`<strong>Erro ao conectar:</strong> ${err}`, '#f8d7da');
                updateStatus(false);
                console.error(err);
            });

        function sendToAtom() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                showAlert('Digite uma mensagem primeiro!', 'error');
                return;
            }

            addLog(`<strong>ENVIANDO:</strong> ${message}...`, '#fff3cd');

            connection.invoke("SendToAtom", message)
                .then(() => {
                    document.getElementById('messageInput').value = '';
                    console.log('Message sent successfully');
                })
                .catch(err => {
                    addLog(`<strong>Erro ao enviar:</strong> ${err}`, '#f8d7da');
                    showAlert('Erro ao enviar mensagem', 'error');
                    console.error(err);
                });
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        function addLog(message, bgColor = '#f8f9fa') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString('pt-PT');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.background = bgColor;
            entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            if (log.children.length > 100) {
                log.removeChild(log.lastChild);
            }
        }

        function updateStatus(isConnected) {
            const status = document.getElementById('status');
            const input = document.getElementById('messageInput');
            const btn = document.getElementById('sendBtn');
            
            status.className = isConnected ? 'status connected' : 'status disconnected';
            status.textContent = isConnected ? 'Conectado ao servidor' : 'Desconectado do servidor';
            
            input.disabled = !isConnected;
            btn.disabled = !isConnected;
        }

        function updateStats() {
            document.getElementById('msgCount').textContent = messageCount;
            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('idCount').textContent = identityCount;
        }

        function displayIdentity(dtc) {
            const container = document.getElementById('identities');
            const card = document.createElement('div');
            card.className = 'identity-card';
            card.innerHTML = `
                <h3>üë§ ${dtc.passengerName || 'N/A'}</h3>
                ${dtc.photoBase64 ? `<img src="data:image/jpeg;base64,${dtc.photoBase64}" alt="Foto">` : '<p><em>Sem foto</em></p>'}
                <p><strong>Passaporte:</strong> ${dtc.passportNumber || 'N/A'}</p>
                <p><strong>Nacionalidade:</strong> ${dtc.nationality || 'N/A'}</p>
                <p><strong>Data Nascimento:</strong> ${dtc.dateOfBirth ? new Date(dtc.dateOfBirth).toLocaleDateString('pt-PT') : 'N/A'}</p>
                <p><strong>Recebido:</strong> ${new Date(dtc.receivedAt).toLocaleString('pt-PT')}</p>
                ${dtc.isComplete ? '<p style="color: green;">Dados completos</p>' : '<p style="color: orange;">‚ö†Ô∏è Dados incompletos</p>'}
            `;
            container.insertBefore(card, container.firstChild);
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendToAtom();
        });
    </script>
</body>
</html>